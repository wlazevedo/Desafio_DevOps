---
- name: Provisionar e configurar ambiente completo DevOps no GKE
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - vars/main.yaml

  tasks:
    # 1. Autenticação no GKE
    - name: Autenticar no GKE (obter credenciais)
      ansible.builtin.command: >
        gcloud container clusters get-credentials {{ cluster_name }}
        --zone {{ zone }}
        --project {{ project_id }}
      changed_when: false

    # 2. Instalar Cert-Manager
    - name: Adicionar Jetstack Helm repo
      kubernetes.core.helm_repository:
        name: jetstack
        repo_url: https://charts.jetstack.io

    - name: Atualizar repositórios Helm
      ansible.builtin.command: helm repo update
      changed_when: false

    - name: Instalar Cert-Manager (Helm)
      kubernetes.core.helm:
        name: cert-manager
        chart_ref: jetstack/cert-manager
        release_namespace: cert-manager
        create_namespace: true
        wait: true
        timeout: "300s"
        values:
          installCRDs: true

    # 3. Aguardar CRDs do cert-manager
    - name: Aguardar CRDs do Cert-Manager estarem prontos
      kubernetes.core.k8s_info:
        api_version: apiextensions.k8s.io/v1
        kind: CustomResourceDefinition
      register: crds
      retries: 20
      delay: 10
      until: >
        crds.resources is defined and
        'certificates.cert-manager.io' in crds.resources | map(attribute='metadata.name') | list
      changed_when: false

    # 4. Aplicar ClusterIssuer
    - name: Aplicar ClusterIssuer (Let's Encrypt)
      kubernetes.core.k8s:
        state: present
        src: ../k8s/clusterissuer-prod.yaml

    # 5. Instalar ingress-nginx via Helm
    - name: Instalar ingress-nginx
      kubernetes.core.helm:
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        release_namespace: ingress-nginx
        create_namespace: true
        wait: true
        timeout: "300s"

    # 6. Aguardar IP externo do ingress-nginx
    - name: Aguardar IP externo do ingress-nginx
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        namespace: ingress-nginx
        name: ingress-nginx-controller
      register: nginx_svc
      retries: 30
      delay: 10
      until: >
        nginx_svc.resources is defined and
        nginx_svc.resources[0].status.loadBalancer.ingress is defined
      changed_when: false

    - name: Exibir IP externo
      ansible.builtin.debug:
        msg: >
          "Ingress EXTERNAL IP: {{
            nginx_svc.resources[0].status.loadBalancer.ingress[0].ip
          }}"

    # 7. Aplicar todos os manifests
    - name: Aplicar Manifestos principais
      kubernetes.core.k8s:
        state: present
        src: "{{ item }}"
      loop:
        - ../k8s/namespace.yaml
        - ../k8s/deployment.yaml
        - ../k8s/service.yaml
        - ../k8s/ingress.yaml

    - name: Aplicar RBAC / NetworkPolicy / HPA
      kubernetes.core.k8s:
        state: present
        src: "{{ item }}"
      loop:
        - ../k8s/rbac.yaml
        - ../k8s/networkpolicy.yaml
        - ../k8s/hpa.yaml

    # 8. Garantir permissão de execução dos scripts
    - name: Garantir permissão nos scripts
      ansible.builtin.file:
        path: "{{ item }}"
        mode: "0755"
      loop:
        - ../monitoring/setup-monitoring.sh
        - ../security/install-vault.sh

    # 9. Executar stack de monitoramento
    - name: Instalar stack de monitoramento
      ansible.builtin.command: bash ../monitoring/setup-monitoring.sh
      register: monitoring_output
      changed_when: true
      failed_when: "'Error:' in monitoring_output.stderr"

    # 10. Instalar Vault
    - name: Instalar Vault (modo dev)
      ansible.builtin.command: bash ../security/install-vault.sh
      register: vault_output
      changed_when: true
      failed_when: "'Error:' in vault_output.stderr"
